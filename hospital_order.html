<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Hospital â€” Request Ambulance</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <link rel="stylesheet" href="hospital.css" />
  </head>
  <body>
    <h1>Hospital â€” Request Ambulance</h1>

    <div class="container">
      <div class="card form-area">
        <input id="hospitalId" placeholder="Hospital Name" />
        <ul id="hospitalSuggestions"></ul>

        <input id="patientName" placeholder="Patient Name" />
        <input
          id="pickupSearch"
          placeholder="Enter address or pincode"
          autocomplete="off"
        />
        <ul id="suggestions"></ul>

        <button id="useMyLocation">Use My Current Location</button>
        <button id="useTypedLocation">Use This Location</button>

        <select id="priority">
          <option value="normal">Normal</option>
          <option value="urgent">Urgent</option>
          <option value="critical">Critical</option>
        </select>

        <textarea id="notes" placeholder="Extra Notes"></textarea>
        <button id="requestBtn">Request Ambulance</button>
        <button id="emergencyBtn" style="background: red; color: white">
          ðŸš¨ Emergency Booking
        </button>
        <div id="statusArea" class="small">No requests yet.</div>
      </div>

      <div id="map"></div>
    </div>

    <script type="module">
      import { odishaHospitals } from "./hospitals.js";
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        onValue,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

      // ðŸ”¹ Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyCVOmAoo9h2-VJ6I7OCK2Naj2fYQq_Io1s",
        authDomain: "ambulance-tracking-syste-21793.firebaseapp.com",
        databaseURL:
          "https://ambulance-tracking-syste-21793-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "ambulance-tracking-syste-21793",
        storageBucket: "ambulance-tracking-syste-21793.appspot.com",
        messagingSenderId: "1057546446784",
        appId: "1:1057546446784:web:549e7f233fdd29786fca25",
      };
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // ðŸ”¹ DOM Elements
      const hospitalInput = document.getElementById("hospitalId");
      const hospitalSuggestions = document.getElementById(
        "hospitalSuggestions"
      );
      const patientNameInput = document.getElementById("patientName");
      const pickupSearchInput = document.getElementById("pickupSearch");
      const statusArea = document.getElementById("statusArea");
      let selectedCoords = null;
      let pickupMarker = null;
      let selectedHospital = null;

      // ðŸ”¹ Custom Icons
      const ambulanceIcon = L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/3181/3181919.png",
        iconSize: [40, 40],
        iconAnchor: [20, 20],
        popupAnchor: [0, -20],
      });

      const hospitalIcon = L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/3176/3176366.png",
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -35],
      });

      // ðŸ”¹ Map Setup
      const map = L.map("map").setView([20.5937, 78.9629], 5);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      // ðŸ”¹ Helper
      function safeUpdateMap(lat, lng, text, markerRef) {
        if (!lat || !lng || isNaN(lat) || isNaN(lng)) return markerRef;
        if (markerRef) map.removeLayer(markerRef);
        map.setView([lat, lng], 15);
        return L.marker([lat, lng]).addTo(map).bindPopup(text).openPopup();
      }

      async function reverseGeocode(lat, lon) {
        try {
          const resp = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`
          );
          return await resp.json();
        } catch {
          return null;
        }
      }

      // ðŸ”¹ Address Search
      const suggestionsList = document.getElementById("suggestions");
      pickupSearchInput.addEventListener("input", async () => {
        const query = pickupSearchInput.value.trim();
        if (query.length < 3) {
          suggestionsList.innerHTML = "";
          return;
        }
        const resp = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
            query
          )}&limit=5`
        );
        const data = await resp.json();
        suggestionsList.innerHTML = "";
        data.forEach((place) => {
          const li = document.createElement("li");
          li.textContent = place.display_name;
          li.onclick = () => {
            pickupSearchInput.value = place.display_name;
            selectedCoords = [parseFloat(place.lat), parseFloat(place.lon)];
            pickupMarker = safeUpdateMap(
              selectedCoords[0],
              selectedCoords[1],
              "Pickup Location",
              pickupMarker
            );
            suggestionsList.innerHTML = "";
          };
          suggestionsList.appendChild(li);
        });
      });

      // ðŸ”¹ Current Location
      document.getElementById("useMyLocation").onclick = () => {
        navigator.geolocation.getCurrentPosition(async (pos) => {
          selectedCoords = [pos.coords.latitude, pos.coords.longitude];
          const data = await reverseGeocode(
            pos.coords.latitude,
            pos.coords.longitude
          );
          pickupSearchInput.value =
            data?.display_name || "Your Current Location";
          pickupMarker = safeUpdateMap(
            selectedCoords[0],
            selectedCoords[1],
            "Pickup Location",
            pickupMarker
          );
        });
      };

      // ðŸ”¹ Hospital Autocomplete
      hospitalInput.addEventListener("input", () => {
        const query = hospitalInput.value.toLowerCase().trim();
        hospitalSuggestions.innerHTML = "";
        if (!query) return;
        const matches = odishaHospitals.filter((h) =>
          (h?.name || "").toLowerCase().includes(query)
        );
        matches.forEach((hospital) => {
          const li = document.createElement("li");
          li.textContent = hospital.name;
          li.onclick = () => {
            hospitalInput.value = hospital.name;
            hospitalSuggestions.innerHTML = "";
            selectedHospital = hospital;
          };
          hospitalSuggestions.appendChild(li);
        });
      });

      // ðŸ”¹ Fetch real ambulances from Firebase
      let ambulances = [];

      function loadAmbulances() {
        const ambRef = ref(db, "ambulances"); // instead of root

        onValue(ambRef, (snapshot) => {
          ambulances = [];
          snapshot.forEach((child) => {
            const amb = child.val();
            if (amb.lat && amb.lng) {
              ambulances.push({
                id: child.key,
                driver: amb.driver || "-",
                plate: amb.plate || child.key,
                lat: amb.lat,
                lng: amb.lng,
                status: amb.status || "unknown",
              });
            }
          });

          console.log("âœ… Loaded ambulances:", ambulances);
          
        });
      }

      loadAmbulances();

      // ðŸ”¹ Cost Function
      function calcCost(lat1, lng1, lat2, lng2) {
        const R = 6371;
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLng = ((lng2 - lng1) * Math.PI) / 180;
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLng / 2) *
            Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return (R * c * 10).toFixed(0);
      }

      // ðŸ”¹ Show Ambulances
      function showAmbulances() {
        ambulances.forEach((amb) => {
          let cost = "N/A";

          if (selectedCoords && selectedHospital) {
            cost = calcCost(
              selectedCoords[0],
              selectedCoords[1],
              selectedHospital.lat,
              selectedHospital.lng
            );
          }

          const marker = L.marker([amb.lat, amb.lng], {
            icon: ambulanceIcon,
          }).addTo(map);

          marker.bindPopup(
            `<b>ðŸš‘ Ambulance ${amb.plate}</b><br>Driver: ${amb.driver}<br>
       Cost: ${
         cost !== "N/A" ? "â‚¹" + cost : "âš  Select pickup & hospital first"
       }<br>
       <button onclick="window.confirmBooking('${
         amb.id
       }')">Confirm Booking</button>`
          );
        });
      }

      // ðŸ”¹ Live Tracking (original variables; reused below)
      let activeAmbulanceMarker = null;
      let hospitalDestMarker = null;
      let activeRouteLine = null;

      function trackAmbulance(ambId, hospital) {
        const ambRef = ref(db, `ambulances/${ambId}`);
        onValue(ambRef, async (snapshot) => {
          const data = snapshot.val();
          if (!data || !data.lat || !data.lng) return;

          if (activeAmbulanceMarker) map.removeLayer(activeAmbulanceMarker);
          activeAmbulanceMarker = L.marker([data.lat, data.lng], {
            icon: ambulanceIcon,
          })
            .addTo(map)
            .bindPopup(`ðŸš‘ ${ambId}<br>Driver: ${data.driver || ""}`)
            .openPopup();

          if (hospital && hospital.lat && hospital.lng) {
            if (hospitalDestMarker) map.removeLayer(hospitalDestMarker);
            hospitalDestMarker = L.marker([hospital.lat, hospital.lng], {
              icon: hospitalIcon,
            })
              .addTo(map)
              .bindPopup("ðŸ¥ Hospital Destination");

            const url = `https://router.project-osrm.org/route/v1/driving/${data.lng},${data.lat};${hospital.lng},${hospital.lat}?overview=full&geometries=geojson`;
            const resp = await fetch(url);
            const routeData = await resp.json();
            if (!routeData.routes || routeData.routes.length === 0) return;

            const coords = routeData.routes[0].geometry.coordinates.map((c) => [
              c[1],
              c[0],
            ]);
            if (activeRouteLine) map.removeLayer(activeRouteLine);
            activeRouteLine = L.polyline(coords, {
              color: "blue",
              weight: 5,
            }).addTo(map);
            map.fitBounds(activeRouteLine.getBounds(), { padding: [50, 50] });
          }
        });
      }

      // ------------- NEW: drawRoute + trackRequest (only additive) ----------------
      async function drawRoute(startLat, startLng, endLat, endLng) {
        if (!startLat || !startLng || !endLat || !endLng) return;
        try {
          const url = `https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`;
          const resp = await fetch(url);
          const data = await resp.json();
          if (!data.routes || data.routes.length === 0) return;
          const coords = data.routes[0].geometry.coordinates.map((c) => [
            c[1],
            c[0],
          ]);
          if (activeRouteLine) map.removeLayer(activeRouteLine);
          activeRouteLine = L.polyline(coords, {
            color: "blue",
            weight: 5,
          }).addTo(map);
          map.fitBounds(activeRouteLine.getBounds(), { padding: [50, 50] });
        } catch (err) {
          console.error("drawRoute error", err);
        }
      }

      // watches a specific request and updates map based on its status
      function trackRequest(requestId) {
        if (!requestId) return;
        const reqRef = ref(db, "requests/" + requestId);
        onValue(reqRef, (snapshot) => {
          const req = snapshot.val();
          if (!req) return;

          // if ambulance location available â€” show/update ambulance marker
          if (req.ambulanceLat && req.ambulanceLng) {
            if (activeAmbulanceMarker) {
              activeAmbulanceMarker.setLatLng([
                req.ambulanceLat,
                req.ambulanceLng,
              ]);
            } else {
              activeAmbulanceMarker = L.marker(
                [req.ambulanceLat, req.ambulanceLng],
                { icon: ambulanceIcon }
              )
                .addTo(map)
                .bindPopup("ðŸš‘ Ambulance")
                .openPopup();
            }
          }

          // Accepted => route ambulance -> pickup
          if (req.status === "Accepted") {
            if (
              req.ambulanceLat &&
              req.ambulanceLng &&
              req.pickup &&
              req.pickup.lat &&
              req.pickup.lng
            ) {
              drawRoute(
                req.ambulanceLat,
                req.ambulanceLng,
                req.pickup.lat,
                req.pickup.lng
              );
              statusArea.innerText =
                "Driver accepted â€” ambulance is on the way.";
            }
          }

          // PickedUp => route ambulance -> hospital
          if (req.status === "PickedUp") {
            if (
              req.ambulanceLat &&
              req.ambulanceLng &&
              req.hospitalLat &&
              req.hospitalLng
            ) {
              // show hospital marker
              if (hospitalDestMarker) map.removeLayer(hospitalDestMarker);
              hospitalDestMarker = L.marker(
                [req.hospitalLat, req.hospitalLng],
                { icon: hospitalIcon }
              )
                .addTo(map)
                .bindPopup("ðŸ¥ Hospital")
                .openPopup();

              drawRoute(
                req.ambulanceLat,
                req.ambulanceLng,
                req.hospitalLat,
                req.hospitalLng
              );
              statusArea.innerText = "Patient picked up â€” heading to hospital.";
            }
          }

          if (req.status === "Completed") {
            statusArea.innerText = "Trip completed.";
            alert("âœ… Trip completed.");
            // cleanup
            if (activeRouteLine) {
              map.removeLayer(activeRouteLine);
              activeRouteLine = null;
            }
            if (activeAmbulanceMarker) {
              map.removeLayer(activeAmbulanceMarker);
              activeAmbulanceMarker = null;
            }
            if (hospitalDestMarker) {
              map.removeLayer(hospitalDestMarker);
              hospitalDestMarker = null;
            }
          }
        });
      }

      // ðŸ”¹ Confirm Booking
      window.confirmBooking = async (ambId) => {
        const amb = ambulances.find((a) => a.id === ambId);
        if (!amb) return;
        if (!confirm(`Confirm booking ambulance ${amb.plate}?`)) return;

        const requestRef = push(ref(db, "requests"));
        await set(requestRef, {
          hospitalId: selectedHospital.name,
          patientName: patientNameInput.value.trim(),
          pickup: { lat: selectedCoords[0], lng: selectedCoords[1] },
          address: pickupSearchInput.value,
          priority: document.getElementById("priority").value,
          notes: document.getElementById("notes").value.trim(),
          createdAt: serverTimestamp(),
          status: "requested",
          ambulanceId: amb.id,
          ambulancePlate: amb.plate,
          ambulanceDriver: amb.driver,
          hospitalLat: selectedHospital.lat,
          hospitalLng: selectedHospital.lng,
        });

        alert("âœ… Ambulance booked! Now waiting for driver to acceptâ€¦");

        // keep original behavior (tracking ambulance node) but also start tracking the request object
        try {
          trackAmbulance(amb.id, selectedHospital);
        } catch (e) {
          /* ignore */
        }
        try {
          trackRequest(requestRef.key);
        } catch (e) {
          /* ignore */
        }
      };

      // ðŸ”¹ Request Button
      document.getElementById("requestBtn").onclick = () => {
        if (!selectedCoords || !selectedHospital) {
          alert("Please select hospital and location first!");
          return;
        }
        alert("Fetching nearby ambulances...");
        showAmbulances();
      };

      // ðŸ”¹ Emergency Button
      document.getElementById("emergencyBtn").onclick = async () => {
        if (!selectedCoords || !selectedHospital) {
          alert("Please select hospital and location first!");
          return;
        }
        let cheapest = null;
        let cheapestCost = Infinity;
        ambulances.forEach((amb) => {
          const cost = calcCost(
            selectedCoords[0],
            selectedCoords[1],
            selectedHospital.lat,
            selectedHospital.lng
          );
          if (cost < cheapestCost) {
            cheapest = amb;
            cheapestCost = cost;
          }
        });
        if (!cheapest) return;
        if (
          !confirm(
            `ðŸš¨ Emergency! Auto-book ${cheapest.plate} for â‚¹${cheapestCost}?`
          )
        )
          return;

        const requestRef = push(ref(db, "requests"));
        await set(requestRef, {
          hospitalId: selectedHospital.name,
          patientName: patientNameInput.value.trim(),
          pickup: { lat: selectedCoords[0], lng: selectedCoords[1] },
          address: pickupSearchInput.value,
          priority: "critical",
          notes: "Emergency auto booking",
          createdAt: serverTimestamp(),
          status: "requested",
          ambulanceId: cheapest.id,
          ambulancePlate: cheapest.plate,
          ambulanceDriver: cheapest.driver,
          hospitalLat: selectedHospital.lat,
          hospitalLng: selectedHospital.lng,
        });

        alert("ðŸš‘ Emergency ambulance booked! Waiting for driver to accept.");
        try {
          trackAmbulance(cheapest.id, selectedHospital);
        } catch (e) {
          /* ignore */
        }
        try {
          trackRequest(requestRef.key);
        } catch (e) {
          /* ignore */
        }
      };
    </script>
  </body>
</html>
