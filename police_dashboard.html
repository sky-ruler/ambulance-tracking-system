<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Police Dashboard</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #f5f5f5;
      }
      header {
        background: linear-gradient(90deg, #0ea5a3, #06b6d4);
        color: white;
        padding: 12px 20px;
        font-size: 20px;
      }
      .container {
        display: flex;
        padding: 20px;
        gap: 20px;
      }
      #map {
        flex: 2;
        height: 500px;
        border: 1px solid #ccc;
        border-radius: 6px;
      }
      .sidebar {
        flex: 1;
        background: #e0f7fa;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid #ddd;
        overflow-y: auto;
        max-height: 600px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 14px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 6px;
        text-align: left;
      }
      th {
        background: #efefef;
      }

      /* Alert panel */
      .alert-panel {
        background: #fff;
        margin: 15px 20px;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid #ddd;
      }
      .alert-panel h3 {
        margin-top: 0;
      }
      .alert-panel ul { padding-left: 18px; max-height: 200px; overflow-y: auto; }
      .alert-panel li { margin-bottom: 6px; font-size: 14px; }
    </style>
  </head>
  <body>
    <header>ðŸš“ Traffic Police Dashboard</header>

    <div class="container">
      <div id="map"></div>
      <div class="sidebar">
        <h3>Ambulance Requests</h3>
        <table id="requestsTable">
          <thead>
            <tr>
              <th>Patient</th>
              <th>Hospital</th>
              <th>Ambulance Plate</th>
              <th>Priority</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="alert-panel">
      <h3>ðŸš¨ Simulation Alerts</h3>
      <ul id="alertList"></ul>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getDatabase,
        ref,
        onValue,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

      // ---------------- Firebase config ----------------
      const firebaseConfig = {
        apiKey: "AIzaSyCVOmAoo9h2-VJ6I7OCK2Naj2fYQq_Io1s",
        authDomain: "ambulance-tracking-syste-21793.firebaseapp.com",
        databaseURL:
          "https://ambulance-tracking-syste-21793-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "ambulance-tracking-syste-21793",
        storageBucket: "ambulance-tracking-syste-21793.appspot.com",
        messagingSenderId: "1057546446784",
        appId: "1:1057546446784:web:549e7f233fdd29786fca25",
      };
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // ---------------- Map setup ----------------
      const map = L.map("map").setView([20.59, 78.96], 5);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors",
      }).addTo(map);

      // ---------------- Global storage ----------------
      window.ambulanceMarkers = {};
      window.routeLines = {};
      window.hospitalCircles = {};
      const insideAmbulances = new Set();

      const requestsTableBody = document.querySelector("#requestsTable tbody");

      // ---------------- Alerts panel helper ----------------
      function addAlert(msg) {
        const list = document.getElementById("alertList");
        if (!list) return;
        const item = document.createElement("li");
        item.textContent = `â€¢ ${msg}`;
        list.prepend(item);
      }

      // ---------------- Smooth marker movement ----------------
      function smoothMove(marker, newLatLng) {
        try {
          const current = marker.getLatLng();
          const steps = 20;
          let i = 0;
          const interval = setInterval(() => {
            if (i >= steps) {
              clearInterval(interval);
              return;
            }
            const lat = current.lat + ((newLatLng.lat - current.lat) / steps) * i;
            const lng = current.lng + ((newLatLng.lng - current.lng) / steps) * i;
            marker.setLatLng([lat, lng]);
            i++;
          }, 50);
        } catch (e) {
          // marker might be removed â€” ignore
        }
      }

      // ---------------- Draw simple route (OSRM) ----------------
      async function drawRoute(id, ambLat, ambLng, destLat, destLng) {
        try {
          const url = `https://router.project-osrm.org/route/v1/driving/${ambLng},${ambLat};${destLng},${destLat}?overview=full&geometries=geojson`;
          const resp = await fetch(url);
          const data = await resp.json();
          if (!data.routes || !data.routes.length) return;
          const coords = data.routes[0].geometry.coordinates.map((c) => [c[1], c[0]]);
          if (window.routeLines[id]) map.removeLayer(window.routeLines[id]);
          window.routeLines[id] = L.polyline(coords, { color: "blue", weight: 4 }).addTo(map);
        } catch (err) {
          console.error("drawRoute error", err);
        }
      }

      // ---------------- Clear visuals ----------------
      function clearAmbulanceFromMap(id) {
        if (window.ambulanceMarkers[id]) {
          map.removeLayer(window.ambulanceMarkers[id]);
          delete window.ambulanceMarkers[id];
        }
        if (window.hospitalCircles[id]) {
          map.removeLayer(window.hospitalCircles[id]);
          delete window.hospitalCircles[id];
        }
        if (window.routeLines[id]) {
          if (Array.isArray(window.routeLines[id])) {
            window.routeLines[id].forEach((line) => map.removeLayer(line));
          } else {
            map.removeLayer(window.routeLines[id]);
          }
          delete window.routeLines[id];
        }
        const row = document.getElementById(`request-row-${id}`);
        if (row) row.remove();
        insideAmbulances.delete(id);
      }

      // ---------------- Add request to table ----------------
      function addRequestToTable(req, id) {
        let row = document.getElementById(`request-row-${id}`);
        if (!row) {
          row = document.createElement("tr");
          row.id = `request-row-${id}`;
          requestsTableBody.appendChild(row);
        }
        row.innerHTML = `
          <td>${req.patientName || "-"}</td>
          <td>${req.hospitalId || "-"}</td>
          <td>${req.ambulancePlate || "-"}</td>
          <td>${req.priority || "-"}</td>
          <td>${req.status || "-"}</td>
        `;
      }

      // ---------------- Police location + 2km zone ----------------
      let policeLat = null, policeLng = null, policeCircle = null;
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          policeLat = pos.coords.latitude;
          policeLng = pos.coords.longitude;
          policeCircle = L.circle([policeLat, policeLng], {
            radius: 2000, color: "blue", fillColor: "blue", fillOpacity: 0.1
          }).addTo(map).bindPopup("ðŸš“ Police 2km Zone");
          map.setView([policeLat, policeLng], 14);
        }, (err) => {
          // fallback: center on Bhubaneswar if geolocation blocked
          console.warn("Geolocation error (police):", err);
          map.setView([20.2961, 85.8245], 12);
        }, { enableHighAccuracy: true, timeout: 8000 });
      } else {
        map.setView([20.2961, 85.8245], 12);
      }

      // ---------------- IoT demo: dynamic cars + markers ----------------
      let smartCars = [];
      let smartCarMarkers = {};
      const carAlerted = new Set();

      function spawnCarsNearAmbulance(ambLat, ambLng) {
        smartCars.length = 0;
        for (let i = 1; i <= 5; i++) {
          smartCars.push({
            id: "car" + i,
            lat: ambLat + (Math.random() - 0.5) * 0.01,
            lng: ambLng + (Math.random() - 0.5) * 0.01,
            plate: "OD" + (10 + i) + "XX" + (1000 + i),
            driver: "Driver " + i,
          });
        }
      }

      function notifyNearbyCars(ambLat, ambLng, ambPlate) {
        // always spawn dynamic cars so demo always shows alerts for presentation
        spawnCarsNearAmbulance(ambLat, ambLng);
        smartCars.forEach((car) => {
          const dist = map.distance([ambLat, ambLng], [car.lat, car.lng]);
          const uniqueId = `${ambPlate || "amb"}_${car.id}`;

          if (dist <= 800 && !carAlerted.has(uniqueId)) {
            carAlerted.add(uniqueId);

            // Add to alert panel (no loud popup spam)
            addAlert(`ðŸ“¢ IoT Alert: Car ${car.plate} (Driver: ${car.driver}) â†’ Ambulance ${ambPlate} approaching â€” please give way!`);

            if (!smartCarMarkers[car.id]) {
              smartCarMarkers[car.id] = L.marker([car.lat, car.lng], {
                icon: L.icon({
                  iconUrl: "https://cdn-icons-png.flaticon.com/512/744/744465.png",
                  iconSize: [28, 28],
                  iconAnchor: [14, 14],
                }),
              }).addTo(map).bindPopup(`ðŸš— Car: ${car.plate}<br>Driver: ${car.driver}`);
            }

            // auto-clear marker and allow future alerts after 20s
            setTimeout(() => {
              if (smartCarMarkers[car.id]) {
                map.removeLayer(smartCarMarkers[car.id]);
                delete smartCarMarkers[car.id];
              }
              carAlerted.delete(uniqueId);
            }, 20000);
          }
        });
      }

      // ---------------- ETA + Traffic Route (colored segments) ----------------
      function getColorForETA(eta) {
        if (eta <= 5) return "green";
        if (eta <= 10) return "orange";
        return "red";
      }

      async function drawTrafficRoute(id, startLat, startLng, endLat, endLng) {
        try {
          const url = `https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson&steps=true`;
          const resp = await fetch(url);
          const data = await resp.json();
          if (!data.routes || !data.routes.length) return;

          // clear previous segments if any
          if (window.routeLines[id]) {
            if (Array.isArray(window.routeLines[id])) {
              window.routeLines[id].forEach((line) => map.removeLayer(line));
            } else {
              map.removeLayer(window.routeLines[id]);
            }
            delete window.routeLines[id];
          }
          window.routeLines[id] = [];

          const steps = data.routes[0].legs[0].steps;
          const coordsPerStep = steps.map(step => step.geometry.coordinates.map(c => [c[1], c[0]]));

          coordsPerStep.forEach((segment, idx) => {
            const segDist = steps[idx].distance;
            let color = "green";
            if (segDist > 800) color = "red";
            else if (segDist > 400) color = "yellow";
            const poly = L.polyline(segment, { color, weight: 6 }).addTo(map);
            window.routeLines[id].push(poly);
          });

          map.fitBounds(L.polyline(coordsPerStep.flat(), {}).getBounds(), { padding: [30,30] });
        } catch (err) {
          console.error("Traffic Route Error:", err);
        }
      }

      // ---------------- Firebase requests listener ----------------
      const requestsRef = ref(db, "requests");
      requestsTableBody.innerHTML = "";

      onValue(requestsRef, (snapshot) => {
        snapshot.forEach((child) => {
          const req = child.val();
          const id = child.key;

          // skip if missing data or police location unknown yet
          if (!req || !req.ambulanceLat || !req.ambulanceLng || !policeLat || !policeLng) return;

          const ambLatLng = L.latLng(req.ambulanceLat, req.ambulanceLng);
          const distance = map.distance([policeLat, policeLng], ambLatLng);

          // remove trip if completed or out of 2km range
          if (req.status === "Completed" || distance > 2000) {
            clearAmbulanceFromMap(id);
            return;
          }

          // first time ambulance enters police 2km zone
          if (!insideAmbulances.has(id) && distance <= 2000) {
            insideAmbulances.add(id);
            if (req.ambulancePlate && req.ambulancePlate !== "null") {
              addAlert(`ðŸš¨ Ambulance ${req.ambulancePlate || id} entered police 2km zone!`);
              addAlert("ðŸš¦ Traffic Light turned GREEN for ambulance!");
            }
          }

          // show only accepted/pickedup statuses
          if (req.status === "Accepted" || req.status === "PickedUp") {
            addRequestToTable(req, id);

            // add hospital circle if available
            if (req.hospitalLat && req.hospitalLng && !window.hospitalCircles[id]) {
              window.hospitalCircles[id] = L.circle([req.hospitalLat, req.hospitalLng], { radius: 2000, color: "red", fillOpacity: 0.1 }).addTo(map);
            }

            // add / update ambulance marker
            if (!window.ambulanceMarkers[id]) {
              window.ambulanceMarkers[id] = L.marker([req.ambulanceLat, req.ambulanceLng], {
                icon: L.icon({
                  iconUrl: "https://cdn-icons-png.flaticon.com/512/3181/3181919.png",
                  iconSize: [32,32],
                  iconAnchor: [16,16]
                })
              }).addTo(map);
            }

            // keep popup updated
            window.ambulanceMarkers[id].bindPopup(`ðŸš‘ Plate: ${req.ambulancePlate || "-"}<br>Hospital: ${req.hospitalId || "-"}<br>Status: ${req.status || "-"}`);

            // smooth move marker to new position
            smoothMove(window.ambulanceMarkers[id], ambLatLng);

            // IoT demo: spawn cars and notify
            notifyNearbyCars(req.ambulanceLat, req.ambulanceLng, req.ambulancePlate);

            // Trigger other smart-city simulated features (billboards, drone, lights)
            triggerBillboardAlert(req.ambulanceLat, req.ambulanceLng);
            deployDrone(id, req.ambulanceLat, req.ambulanceLng);
            updateTrafficLights(req.ambulanceLat, req.ambulanceLng);
            blinkStreetLights(req.ambulanceLat, req.ambulanceLng);

            // draw appropriate route
            if (req.status === "PickedUp" && req.hospitalLat && req.hospitalLng) {
              if (window.routeLines[id]) {
                if (Array.isArray(window.routeLines[id])) window.routeLines[id].forEach(l => map.removeLayer(l));
                else map.removeLayer(window.routeLines[id]);
                delete window.routeLines[id];
              }
              drawTrafficRoute(id, req.ambulanceLat, req.ambulanceLng, req.hospitalLat, req.hospitalLng);
              addAlert("ðŸ–¼ Digital Billboard: 'Ambulance Approaching â€” Clear Lane!'");
            } else if (req.pickup?.lat && req.pickup?.lng) {
              drawTrafficRoute(id, req.ambulanceLat, req.ambulanceLng, req.pickup.lat, req.pickup.lng);
              addAlert("ðŸš Drone deployed ahead to scout traffic.");
            }
          } // end Accepted/PickedUp branch
        }); // end forEach
      }); // end onValue

      // ---------------- Simulation objects (billboard/drone/lights) ----------------
      const billboardIcon = "https://cdn-icons-png.flaticon.com/512/2972/2972068.png";
      const droneIcon = "https://cdn-icons-png.flaticon.com/512/711/711245.png";
      const trafficLightRed = "https://cdn-icons-png.flaticon.com/512/483/483361.png";
      const trafficLightGreen = "https://cdn-icons-png.flaticon.com/512/483/483408.png";
      const streetLightIcon = "https://cdn-icons-png.flaticon.com/512/1048/1048949.png";

      let billboardMarkers = [];
      let trafficLightMarkers = [];
      let streetLightMarkers = [];
      let droneMarkers = {};
      // store blink intervals so we can clear duplicates
      let streetLightBlinkIntervals = {};

      function setupSimulationObjects() {
        // Billboards
        billboardMarkers = [
          L.marker([20.296, 85.824], { icon: L.icon({ iconUrl: billboardIcon, iconSize: [32,32] }) }).addTo(map).bindPopup("ðŸ–¼ Billboard"),
          L.marker([20.3, 85.828],    { icon: L.icon({ iconUrl: billboardIcon, iconSize: [32,32] }) }).addTo(map).bindPopup("ðŸ–¼ Billboard")
        ];

        // Traffic Lights
        trafficLightMarkers = [
          L.marker([20.298, 85.826], { icon: L.icon({ iconUrl: trafficLightRed, iconSize: [28,28] }) }).addTo(map).bindPopup("ðŸš¦ Traffic Light"),
          L.marker([20.302, 85.83],  { icon: L.icon({ iconUrl: trafficLightRed, iconSize: [28,28] }) }).addTo(map).bindPopup("ðŸš¦ Traffic Light")
        ];

        // Street Lights
        streetLightMarkers = [
          L.marker([20.299, 85.827], { icon: L.icon({ iconUrl: streetLightIcon, iconSize: [26,26] }) }).addTo(map).bindPopup("ðŸ’¡ Smart Street Light"),
          L.marker([20.301, 85.829], { icon: L.icon({ iconUrl: streetLightIcon, iconSize: [26,26] }) }).addTo(map).bindPopup("ðŸ’¡ Smart Street Light")
        ];
      }
      setupSimulationObjects();

      // Trigger billboard alert: make billboard more visible and add alert -> opens popup
      function triggerBillboardAlert(ambLat, ambLng) {
        billboardMarkers.forEach((b) => {
          const dist = map.distance([ambLat, ambLng], b.getLatLng());
          if (dist <= 1000) {
            b.setOpacity(1.0);
            b.bindPopup("ðŸš¨ Billboard Alert: Ambulance Nearby!").openPopup();
            addAlert("ðŸ–¼ Digital Billboard: 'Ambulance Approaching â€” Clear Lane!'");
          } else {
            b.setOpacity(0.5);
          }
        });
      }

      // Drone scouting: position drone a bit ahead of ambulance
      function deployDrone(id, ambLat, ambLng) {
        const droneOffset = [ambLat + 0.003, ambLng + 0.003];
        if (!droneMarkers[id]) {
          droneMarkers[id] = L.marker(droneOffset, { icon: L.icon({ iconUrl: droneIcon, iconSize: [30,30] }) })
            .addTo(map).bindPopup("ðŸš Drone Scouting");
        } else {
          droneMarkers[id].setLatLng(droneOffset);
        }
      }

      // Traffic light pre-emption: switch icon to green when ambulance near
      function updateTrafficLights(ambLat, ambLng) {
        trafficLightMarkers.forEach((t) => {
          const dist = map.distance([ambLat, ambLng], t.getLatLng());
          const iconUrl = dist <= 300 ? trafficLightGreen : trafficLightRed;
          t.setIcon(L.icon({ iconUrl, iconSize: [28,28] }));
          if (dist <= 300) addAlert("ðŸš¦ Traffic Light turned GREEN for ambulance!");
        });
      }

      // Street light blinking simulation: only create one interval per marker
      function blinkStreetLights(ambLat, ambLng) {
        streetLightMarkers.forEach((s, idx) => {
          const dist = map.distance([ambLat, ambLng], s.getLatLng());
          const key = `street-${idx}`;
          if (dist <= 400) {
            if (!streetLightBlinkIntervals[key]) {
              let visible = true;
              streetLightBlinkIntervals[key] = setInterval(() => {
                visible = !visible;
                if (s && s.setOpacity) s.setOpacity(visible ? 1.0 : 0.3);
              }, 700);
              addAlert("ðŸ’¡ Smart streetlights flashing BLUE-WHITE near ambulance!");
            }
          } else {
            // stop blinking if previously started
            if (streetLightBlinkIntervals[key]) {
              clearInterval(streetLightBlinkIntervals[key]);
              streetLightBlinkIntervals[key] = null;
              if (s && s.setOpacity) s.setOpacity(1.0);
            }
          }
        });
      }

      // ------------- End of script -------------
    </script>
  </body>
</html>
